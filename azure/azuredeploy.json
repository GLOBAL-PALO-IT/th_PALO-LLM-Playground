{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "Applied-LLM-Platform",
      "metadata": {
        "description": "Name prefix for all resources"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "containerImage": {
      "type": "string",
      "metadata": {
        "description": "Container image to deploy (e.g., myregistry.azurecr.io/app:latest)"
      }
    },
    "containerPort": {
      "type": "int",
      "defaultValue": 3000,
      "metadata": {
        "description": "Port the container listens on"
      }
    },
    "containerRegistry": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry server (e.g., myregistry.azurecr.io). Leave empty for Docker Hub."
      }
    },
    "containerRegistryUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry username. Leave empty for public registries."
      }
    },
    "containerRegistryPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry password. Leave empty for public registries."
      }
    },
    "postgresAdminUsername": {
      "type": "string",
      "defaultValue": "pgadmin",
      "metadata": {
        "description": "PostgreSQL administrator username"
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL administrator password"
      }
    },
    "postgresDatabaseName": {
      "type": "string",
      "defaultValue": "playground",
      "metadata": {
        "description": "PostgreSQL database name"
      }
    },
    "openaiApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "OpenAI API Key"
      }
    },
    "livekitApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "LiveKit API Key (optional)"
      }
    },
    "livekitApiSecret": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "LiveKit API Secret (optional)"
      }
    },
    "livekitUrl": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "LiveKit URL (optional)"
      }
    },
    "tavilyApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Tavily API Key (optional)"
      }
    },
    "serperApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Serper API Key (optional)"
      }
    },
    "minReplicas": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "maxValue": 25,
      "metadata": {
        "description": "Minimum number of replicas"
      }
    },
    "maxReplicas": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "maxValue": 25,
      "metadata": {
        "description": "Maximum number of replicas"
      }
    }
  },
  "variables": {
    "environmentName": "[concat(parameters('projectName'), '-env')]",
    "containerAppName": "[concat(parameters('projectName'), '-app')]",
    "logAnalyticsName": "[concat(parameters('projectName'), '-logs')]",
    "postgresServerName": "[concat(parameters('projectName'), '-postgres')]",
    "databaseUrl": "[concat('postgresql://', parameters('postgresAdminUsername'), ':', parameters('postgresAdminPassword'), '@', variables('postgresServerName'), '.postgres.database.azure.com:5432/', parameters('postgresDatabaseName'), '?sslmode=require')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2022-12-01",
      "name": "[variables('postgresServerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_B1ms",
        "tier": "Burstable"
      },
      "properties": {
        "version": "15",
        "administratorLogin": "[parameters('postgresAdminUsername')]",
        "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
        "storage": {
          "storageSizeGB": 32
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "highAvailability": {
          "mode": "Disabled"
        }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2022-12-01",
      "name": "[concat(variables('postgresServerName'), '/', parameters('postgresDatabaseName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ],
      "properties": {
        "charset": "UTF8",
        "collation": "en_US.utf8"
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2022-12-01",
      "name": "[concat(variables('postgresServerName'), '/AllowAllAzureServicesAndResourcesWithinAzureIps')]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ],
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2023-05-01",
      "name": "[variables('environmentName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ],
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').primarySharedKey]"
          }
        }
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2023-05-01",
      "name": "[variables('containerAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('environmentName'))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), parameters('postgresDatabaseName'))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/firewallRules', variables('postgresServerName'), 'AllowAllAzureServicesAndResourcesWithinAzureIps')]"
      ],
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('environmentName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": "[parameters('containerPort')]",
            "allowInsecure": false,
            "traffic": [
              {
                "latestRevision": true,
                "weight": 100
              }
            ]
          },
          "registries": "[if(empty(parameters('containerRegistry')), json('[]'), json(concat('[{\"server\": \"', parameters('containerRegistry'), '\", \"username\": \"', parameters('containerRegistryUsername'), '\", \"passwordSecretRef\": \"registry-password\"}]')))]",
          "secrets": "[concat(if(empty(parameters('containerRegistry')), json('[]'), json(concat('[{\"name\": \"registry-password\", \"value\": \"', parameters('containerRegistryPassword'), '\"}]'))), json(concat('[{\"name\": \"database-url\", \"value\": \"', variables('databaseUrl'), '\"}, {\"name\": \"openai-api-key\", \"value\": \"', parameters('openaiApiKey'), '\"}, {\"name\": \"livekit-api-key\", \"value\": \"', parameters('livekitApiKey'), '\"}, {\"name\": \"livekit-api-secret\", \"value\": \"', parameters('livekitApiSecret'), '\"}, {\"name\": \"tavily-api-key\", \"value\": \"', parameters('tavilyApiKey'), '\"}, {\"name\": \"serper-api-key\", \"value\": \"', parameters('serperApiKey'), '\"}]')))]",
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "[variables('containerAppName')]",
              "image": "[parameters('containerImage')]",
              "resources": {
                "cpu": 0.5,
                "memory": "1Gi"
              },
              "env": [
                {
                  "name": "DATABASE_URL",
                  "secretRef": "database-url"
                },
                {
                  "name": "OPENAI_API_KEY",
                  "secretRef": "openai-api-key"
                },
                {
                  "name": "LIVEKIT_API_KEY",
                  "secretRef": "livekit-api-key"
                },
                {
                  "name": "LIVEKIT_API_SECRET",
                  "secretRef": "livekit-api-secret"
                },
                {
                  "name": "LIVEKIT_URL",
                  "value": "[parameters('livekitUrl')]"
                },
                {
                  "name": "TAVILY_API_KEY",
                  "secretRef": "tavily-api-key"
                },
                {
                  "name": "SERPER_API_KEY",
                  "secretRef": "serper-api-key"
                },
                {
                  "name": "NODE_ENV",
                  "value": "production"
                },
                {
                  "name": "PORT",
                  "value": "3000"
                },
                {
                  "name": "NEXT_PUBLIC_API_URL",
                  "value": "[concat('https://', variables('containerAppName'), '.', reference(resourceId('Microsoft.App/managedEnvironments', variables('environmentName')), '2023-05-01').defaultDomain)]"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": "[parameters('minReplicas')]",
            "maxReplicas": "[parameters('maxReplicas')]",
            "rules": [
              {
                "name": "http-scaling",
                "http": {
                  "metadata": {
                    "concurrentRequests": "10"
                  }
                }
              }
            ]
          }
        }
      }
    }
  ],
  "outputs": {
    "containerAppFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01').configuration.ingress.fqdn]"
    },
    "containerAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01').configuration.ingress.fqdn)]"
    },
    "postgresServerName": {
      "type": "string",
      "value": "[variables('postgresServerName')]"
    },
    "postgresFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2022-12-01').fullyQualifiedDomainName]"
    },
    "databaseName": {
      "type": "string",
      "value": "[parameters('postgresDatabaseName')]"
    }
  }
}
